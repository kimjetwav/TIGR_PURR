singularity {

    autoMounts=true
    enabled=true

}

simg = "/archive/code/containers/FMRIPREP/poldracklab_fmriprep_1.4.1-2019-07-09-6b9ad6995846.simg"
invocation = "/archive/code/boutiques_jsons/invocations/dmriprep-0.2.0_invocation.json"
descriptor = "/archive/code/boutiques_jsons/descriptors/dmriprep-0.2.0.json"

profiles {

    //DEFAULT
    standard {

        process.executor = "SLURM"
        process.queue = "high-moby"
        params.simg = "$simg" 
        params.invocation= "$invocation"
        params.descriptor = "$descriptor"
    }   

    kimel_cpu {

        process.executor = "SLURM"
        process.queue = "high-moby"
        process.clusterOptions = "--time=24:00:00 --mem-per-cpu=4096\
         --cpus-per-task=4 --job-name dmriprep_pipeline\
         --nodes=1"
        params.simg = "$simg" 
        params.invocation= "$invocation"
        params.descriptor = "$descriptor"
    }   

    kimel_cuda {

        process.executor = "SLURM"
        process.queue = "cudansha"
        process.clusterOptions = "--time=24:00:00 --mem-per-cpu=4096\
         --cpus-per-task=4 --job-name dmriprep_pipeline\
         --nodes=1, --gres=gpu:1"
        params.simg = "$simg" 
        params.invocation= "$invocation"
        params.descriptor = "$descriptor"

    }

    scc {

        process.executor = "SLURM"
        process.queue = "long"
        params.simg = "/KIMEL/tigrlab/$simg" 
        params.invocation= "/KIMEL/tigrlab/$invocation"
        params.descriptor = "/KIMEL/tigrlab/$descriptor"

    }

    local {

        process.executor = "local"
        params.simg = "$simg" 
        params.invocation= "$invocation"
        params.descriptor = "$descriptor"

    }


}

retry_val = 3

process {

    withName: modify_invocation{

        executor = 'local'

    }
    withName: run_bids {
        
        maxRetries = retry_val
        errorStrategy = {task.attempt == retry_val ? "finish" : "retry"}

    }
}
